---
- hosts: localhost
  connection: local
  vars:
    fzf_version: "0.17.3"
    fzf_plugin_path: "{{ ansible_env.HOME }}/.fzf"
    omz_plugin_path: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins"
    zsh_bin_path: "{{ ansible_env.HOME }}/.zsh/bin"

  # pre_tasks:

  #   - name: update cache
  #     become: true
  #     apt: update_cache=yes cache_valid_time=3600

  tasks:

    # - name: Install ZSH, GIT and CURL
    #   apt: name={{ item }} state=present update_cache=no
    #   become: true
    #   with_items:
    #     - git
    #     - curl
    #     - zsh
    #     - xclip
    #     - silversearcher-ag

    - name: Install Oh-My-ZSH
      command: curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh
      args:
        creates: "{{ ansible_env.HOME }}/.oh-my-zsh"

    - name: Create ZSH Symlink
      file:
        src: "{{ playbook_dir }}/{{ item }}"
        dest: "{{ ansible_env.HOME }}/{{ item }}"
        state: link
      with_items:
        - .zshrc
        - .zshrc.aliases
        - .zsh-completions
        - .zsh-configs
        - .desk

    - name: Create ZSH Bin Symlink
      file:
        src: "{{ playbook_dir }}/../bin"
        dest: "{{ zsh_bin_path }}"
        state: link

    - name: Install FZF
      shell: >
        curl -L "https://github.com/junegunn/fzf-bin/releases/download/{{ fzf_version }}/fzf-{{ fzf_version }}-linux_amd64.tgz" | tar -xvz;
        mv "{{ playbook_dir }}/fzf" "{{ zsh_bin_path }}/fzf"
      args:
        creates: "{{ zsh_bin_path }}/fzf"

    - name: Install FZF Plugin
      shell: >
        git clone --depth 1 https://github.com/junegunn/fzf.git "{{ fzf_plugin_path }}";
        bash -c "yes | {{ fzf_plugin_path }}/install"
      args:
        creates: "{{ ansible_env.HOME }}/.fzf.zsh"

    - name: Install ZSH Plugins
      git:
        repo: "{{ item.url }}"
        dest: "{{ item.dest }}"
      with_items:
        - { url: "https://github.com/zsh-users/zsh-autosuggestions", dest: "{{ omz_plugin_path }}/zsh-autosuggestions" }
        - { url: "https://github.com/zsh-users/zsh-syntax-highlighting", dest: "{{ omz_plugin_path }}/zsh-syntax-highlighting" }
        - { url: "https://github.com/pasky/speedread", dest: "{{ omz_plugin_path }}/speedread" }

    - name: Install desk
      shell: >
        curl -L https://raw.githubusercontent.com/jamesob/desk/master/desk > "{{ zsh_bin_path }}/desk" &&
          chmod +x "{{ zsh_bin_path }}/desk" &&
          git clone git@github.com:jamesob/desk.git /tmp/desk &&
          cp -r /tmp/desk/shell_plugins/zsh "{{ omz_plugin_path}}/desk";
        rm -rf /tmp/desk
      args:
        creates: "{{ zsh_bin_path }}/desk"