---
# Backup existing configurations before making changes

- name: Create backup directory with timestamp
  ansible.builtin.file:
    path: "{{ general.backup_dir }}"
    state: directory
    mode: '0755'

- name: Backup existing shell configurations
  ansible.builtin.copy:
    src: "{{ general.local_home }}/{{ item }}"
    dest: "{{ general.backup_dir }}/{{ item }}"
    remote_src: true
    mode: preserve
  loop:
    - .zshrc
    - .bashrc
    - .bash_profile
    - .profile
  failed_when: false
  register: shell_backup

- name: Backup existing development tool configs
  ansible.builtin.copy:
    src: "{{ general.local_home }}/{{ item }}"
    dest: "{{ general.backup_dir }}/{{ item }}"
    remote_src: true
    mode: preserve
  loop:
    - .vimrc
    - .tmux.conf
    - .gitconfig
    - .npmrc
  failed_when: false
  register: tool_backup

- name: Create backup manifest
  ansible.builtin.copy:
    content: |
      Backup created: {{ ansible_date_time.iso8601 }}
      Backup location: {{ general.backup_dir }}
      Hostname: {{ ansible_hostname }}
      User: {{ ansible_user_id }}
      
      Backed up files:
      {% for item in shell_backup.results %}
      - {{ item.item if item.changed else item.item + ' (not found)' }}
      {% endfor %}
      {% for item in tool_backup.results %}
      - {{ item.item if item.changed else item.item + ' (not found)' }}
      {% endfor %}
    dest: "{{ general.backup_dir }}/BACKUP_MANIFEST.txt"
    mode: '0644'

- name: Display backup location
  ansible.builtin.debug:
    msg: "Configuration backup created at: {{ general.backup_dir }}"
