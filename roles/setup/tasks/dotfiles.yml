---
- name: Check if iTerm2 is installed
  ansible.builtin.stat:
    path: "/Applications/iTerm.app"
  register: iterm_check

- name: Clone dotfiles repository
  ansible.builtin.git:
    repo: "{{ repositories.dotfiles }}"
    dest: "{{ general.setup_dir }}/dotfiles"
    update: true
  register: dotfiles_clone

- name: Backup existing dotfiles
  ansible.builtin.copy:
    src: "{{ general.local_home }}/{{ item }}"
    dest: "{{ general.backup_dir }}/{{ item }}"
    remote_src: true
    mode: preserve
  loop:
    - .zshrc
    - .vimrc
    - .tmux.conf
    - .thymerc
  when: install_behavior.create_backup | default(true)
  failed_when: false

- name: Create symlink for zsh configuration
  ansible.builtin.file:
    src: "{{ general.setup_dir }}/dotfiles/zsh/.zshrc"
    dest: "{{ general.local_home }}/.zshrc"
    state: link
    force: true
  notify: shell config changed

- name: Create symlink for vim configuration
  ansible.builtin.file:
    src: "{{ general.setup_dir }}/dotfiles/vim/.vimrc"
    dest: "{{ general.local_home }}/.vimrc"
    state: link
    force: true
  notify: vim config changed

- name: Create symlink for tmux configuration
  ansible.builtin.file:
    src: "{{ general.setup_dir }}/dotfiles/tmux/.tmux.conf"
    dest: "{{ general.local_home }}/.tmux.conf"
    state: link
    force: true
  notify: tmux config changed

- name: Create symlink for thyme configuration
  ansible.builtin.file:
    src: "{{ general.setup_dir }}/dotfiles/thyme/.thymerc"
    dest: "{{ general.local_home }}/.thymerc"
    state: link
    force: true
  when: iterm_check.stat.exists

- name: Create iTerm2 utilities directory
  ansible.builtin.file:
    path: "{{ general.local_home }}/.iterm2"
    state: directory
    mode: '0755'
  when: iterm_check.stat.exists

- name: Copy iTerm2 utilities
  ansible.builtin.copy:
    src: "{{ general.setup_dir }}/dotfiles/iterm/iterm2/{{ item }}"
    dest: "{{ general.local_home }}/.iterm2/{{ item }}"
    remote_src: true
    mode: '0755'
  loop:
    - imgcat
    - imgls
    - it2dl
  when: iterm_check.stat.exists
  failed_when: false
